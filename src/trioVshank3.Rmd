---
title: "Correlation between Trio and Shank3"
output: html_notebook
---
```{r}
# Load data and libraries
rm(list=ls())
require(readxl)
require(tidyverse)
require(tm)
require(ggfortify)
require(PCAtools)
require(reshape2)
require(ggbeeswarm)
require(EnhancedVolcano)
require(RColorBrewer)
require(fgsea)
require(ComplexHeatmap)
files.sources = list.files("../functions" , full.names = TRUE)
invisible(lapply(files.sources, source))
```

```{r}
trio.xls <- read_xlsx("../data/results_PSD-Trio-proteome_Two-sample_mod_T_2020-07-24.xlsx")
trio.xls <- trio.xls %>% drop_na(logFC.WT.over.KO)
shank3.xls <- read_xlsx("../data/results_PSD-Shank3-proteome_Two-sample_mod_T_2020-07-22.xlsx")
grin2a.xls <- read_xlsx("../data/results_Glun2a-TMT16-Proteome_Two-sample_mod_T_2020-11-30.xlsx")
shank3.xls <- shank3.xls %>% drop_na(logFC.WT.over.KO)
```
The number of proteins measured in Trio PSD is:
```{r}
dim(trio.xls)[1]
```
The number of proteins measured in Shank3 PSD is:
```{r}
dim(shank3.xls)[1]
```

The number of proteins measured across both experiments is:
```{r}
sharedIds <- intersect(trio.xls$id, shank3.xls$id)
length(sharedIds)
```
699 proteins measured in Trio PSD but not Shank3. 1534 proteins measured in Shank3 PSD but not Trio.
```{r}
length(setdiff(trio.xls$id, shank3.xls$id))
length(setdiff(shank3.xls$id, trio.xls$id))
```
```{r}
#trio.shared <- trio.xls %>% subset(id %in% sharedIds)
#shank3.shared <- shank3.xls %>% subset(id %in% sharedIds)
goPathways <- "~/Google Drive/geneSets/mSigDb/v7_2/ontology/c5.all.v7.2.symbols.gmt"
pathways.go <- gmtPathways(goPathways)
rnaSplicing <- str_to_title(pathways.go$GO_RNA_SPLICING)
cytosolicRibosome <- str_to_title(pathways.go$GO_CYTOSOLIC_RIBOSOME)
oxPhos <- str_to_title(pathways.go$GO_OXIDATIVE_PHOSPHORYLATION)
imn <- str_to_title(pathways.go$GO_IMMUNE_RESPONSE_REGULATING_SIGNALING_PATHWAY)
cplmnt <- str_to_title(pathways.go$GO_COMPLEMENT_ACTIVATION)
glutamateSignaling <- str_to_title(pathways.go$GO_GLUTAMATE_RECEPTOR_SIGNALING_PATHWAY)
fcSignaling <- str_to_title(pathways.go$GO_FC_RECEPTOR_SIGNALING_PATHWAY)
rnaSplicing.curr <- intersect(rnaSplicing, joint$geneSymbol.x)
cytosolicRibosome.curr <- intersect(cytosolicRibosome, joint$geneSymbol.x)


pVal <- 0.1
plotWidth <- 12
plotHeight <- 8
trio.xls <- trio.xls %>% dplyr::mutate(logFC.KO.over.WT = logFC.WT.over.KO*(-1))
shank3.xls <- shank3.xls %>% dplyr::mutate(logFC.KO.over.WT = logFC.WT.over.KO*(-1))
joint <- inner_join(trio.xls, shank3.xls, by='id')
joint <- joint %>% mutate(trio.sig = ifelse(P.Value.WT.over.KO.x < pVal, 1, 0))
joint <- joint %>% mutate(shank3.sig = ifelse(P.Value.WT.over.KO.y < pVal, 2, 0))
joint <- joint %>% mutate(both.sig = as.factor(trio.sig + shank3.sig))
joint <- joint %>% mutate(splicing = ifelse(geneSymbol.x %in% rnaSplicing, 1, 0))
joint <- joint %>% mutate(cytosolicRibosome = ifelse(geneSymbol.x %in% cytosolicRibosome, 2, 0))
joint <- joint %>% mutate(mito = ifelse(geneSymbol.x %in% oxPhos, 1, 0))
joint <- joint %>% mutate(immune = ifelse(geneSymbol.x %in% imn, 1, 0))
joint <- joint %>% mutate(complement = ifelse(geneSymbol.x %in% cplmnt, 1, 0))
joint <- joint %>% mutate(glutSignal = ifelse(geneSymbol.x %in% glutamateSignaling, 1, 0))
joint <- joint %>% mutate(fcRecSignal = ifelse(geneSymbol.x %in% fcSignaling, 1, 0))
joint <- joint %>% mutate(spl.ribo = splicing + cytosolicRibosome)

curDat <- joint %>% select(id, geneSymbol.x,
                           geneSymbol.y, 
                           logFC.KO.over.WT.x, 
                           logFC.KO.over.WT.y, 
                           trio.sig, 
                           shank3.sig, 
                           both.sig, 
                           splicing,
                           cytosolicRibosome,
                           spl.ribo,
                           mito,
                           immune,
                           complement,
                           glutSignal,
                           fcRecSignal) 

curDat <-  curDat %>% rename(x=logFC.KO.over.WT.x, y=logFC.KO.over.WT.y)
cor(joint$logFC.KO.over.WT.x, joint$logFC.KO.over.WT.y)


curDat <- curDat %>% mutate(color=both.sig)
lab  <- c("NS", "Sig. Trio KO", "Sig. Shank3 KO", "Sig. Both")
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse((color==3 | y < -5 | x < -5 ), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
#scPlot <- scPlot + coord_cartesian(xlim=c(-3,3))
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatterP1.pdf", width = plotWidth, height = plotHeight, units = "in")



curDat <- curDat %>% mutate(color=splicing)
lab <- c("", "RNA splicing")
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==1 & x> 2) | (color==1 & y > 2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25, size=3)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_splicing.pdf", width = plotWidth, height = plotHeight, units = "in")



lab <- c("", "Cytosolic ribosome")
curDat <- curDat %>% mutate(color=cytosolicRibosome)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==2 & x> 2) | (color==2 & y > 2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_ribosome.pdf", width = plotWidth, height = plotHeight, units = "in")


lab <- c("","RNA splicing", "Cytosolic ribosome","Both")
curDat <- curDat %>% mutate(color=spl.ribo)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==2 & x> 2) | (color==2 & y > 2) |  (color==1 & x > 2) |  (color==1 & y > 2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_splicing_ribosome.pdf", width = plotWidth, height = plotHeight, units = "in")

lab <- c("", "Oxidative phosphorylation")
curDat <- curDat %>% mutate(color=mito)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==1 & x> 2) | (color==1 & y > 2) | (color==1 & y < -2) | (color==1 & x < -2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_oxidative_phosphorylation.pdf", width = plotWidth, height = plotHeight, units = "in")


lab <- c("", "Immune response signaling")
curDat <- curDat %>% mutate(color=immune)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==1 & x> 2) | (color==1 & y > 2) | (color==1 & y < -2) | (color==1 & x < -2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_immune_response.pdf", width = plotWidth, height = plotHeight, units = "in")

lab <- c("", "Complement activation")
curDat <- curDat %>% mutate(color=complement)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==1 & x> 2) | (color==1 & y > 2) | (color==1 & y < -2) | (color==1 & x < -2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_complement_activation.pdf", width = plotWidth, height = plotHeight, units = "in")

lab <- c("", "Gluatamate receptor signaling")
curDat <- curDat %>% mutate(color=glutSignal)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==1 & x> 2) | (color==1 & y > 2) | (color==1 & y < -2) | (color==1 & x < -2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_glutamateSignaling.pdf", width = plotWidth, height = plotHeight, units = "in")

lab <- c("", "FC receptor signaling")
curDat <- curDat %>% mutate(color=fcRecSignal)
scPlot <- makeScatterPlot(curDat, lab)
scPlot <- scPlot + xlab("Log2-fold change (Trio KO/WT)") + ylab("Log2-fold change (Shank3 KO/WT)")
scPlot <- scPlot + geom_text_repel(aes(label=ifelse(((color==1 & x> 2) | (color==1 & y > 2) | (color==1 & y < -2) | (color==1 & x < -2)), as.character(geneSymbol.x), '')), show.legend = FALSE, segment.color='black', segment.size = .5, segment.alpha = .25)
scPlot
ggsave("~/Google Drive/psp/analysis/plots/trioVshank3/lfcScatter_fcRecSignaling.pdf", width = plotWidth, height = plotHeight, units = "in")



#geneSymbol.x %in%rnaSplicing.curr | | geneSymbol.x %in% cytosolicRibosome.curr

hMaps.splicing <- makeHeatMap(joint, rnaSplicing.curr)
hMaps.ribosome <- makeHeatMap(joint, cytosolicRibosome.curr)
hMaps.mito <- makeHeatMap(joint, oxPhos)
hMaps.glut <- makeHeatMap(joint, glutamateSignaling)
hMaps.fc <- makeHeatMap(joint, fcSignaling)
hMaps.immune <- makeHeatMap(joint, imn)

joint <- joint %>% mutate(logFC.Het.over.WT.x = (-1)*logFC.WT.over.Het.x,
                              logFC.Het.over.WT.y = (-1)*logFC.WT.over.Het.y)

rp.lfc <- joint %>% filter(geneSymbol.x %in%rnaSplicing.curr | geneSymbol.x %in% cytosolicRibosome.curr) %>% select(geneSymbol.x, logFC.Het.over.WT.x, logFC.KO.over.WT.x, logFC.Het.over.WT.y, logFC.KO.over.WT.y) %>%
  rename(geneSymbol=geneSymbol.x, Trio.Het=logFC.Het.over.WT.x, Trio.KO=logFC.KO.over.WT.x, Shank3.Het=logFC.Het.over.WT.y, Shank3.KO=logFC.KO.over.WT.y)

rp.lfc.tmp <- distinct(rp.lfc, geneSymbol, .keep_all = TRUE)
rp.lfc.mat <- as.data.frame(rp.lfc.tmp %>% select(-c("geneSymbol")))
rNames <- rp.lfc.tmp %>% select("geneSymbol")
rownames(rp.lfc.mat) <- rNames$geneSymbol

spriboHmap <- Heatmap(rp.lfc.mat, 
                      row_names_gp = gpar(fontsize = 4), 
                      cluster_columns = FALSE,
                      )
spriboHmap


```


```{r}
trio.sig <- trio.xls %>% filter(P.Value.WT.over.KO < 0.1) %>% select(id, geneSymbol, logFC.KO.over.WT, P.Value.WT.over.KO)
shank3.sig <- shank3.xls %>% filter(P.Value.WT.over.KO < 0.1) %>% select(id, geneSymbol, logFC.KO.over.WT, P.Value.WT.over.KO)
trio.sig.int.shank3.sig <- intersect(shank3.sig$id, trio.sig$id)
trio.com <- trio.sig %>% subset(id %in% trio.sig.int.shank3.sig)
shank3.com <- shank3.sig %>% subset(id %in% trio.sig.int.shank3.sig)
com <- inner_join(trio.com, shank3.com, by='id')
com <- com %>% arrange(desc(logFC.KO.over.WT.y))
com
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
