---
title: "Shank3 PSD proteome analysis"
output:
  html_document: default
  html_notebook: default
---

Sameer Aryal //
Postdoctoral Associate //
Sheng Laboratory //
Broad Institute of MIT and Harvard //

Oct. 9, 2020 //

How does genetically removing Shank3 alter the postsynaptic density (PSD) proteome?
Examining TMT labeled PSD proteome from WT, Shank3/+, and Shank3/Shank3 mice. 
Experiment carried out by Borislav Dejanovic. 

```{r}
# Load data and libraries
rm(list=ls())
require(readxl)
require(tidyverse)
require(tm)
require(ggfortify)
require(PCAtools)
require(reshape2)
require(ggbeeswarm)
require(EnhancedVolcano)
require(RColorBrewer)
require(fgsea)
require(ComplexHeatmap)
```

```{r}
files.sources = list.files("../functions" , full.names = TRUE)
invisible(lapply(files.sources, source))
shank3.xls <- read_xlsx("../data/results_PSD-Shank3-proteome_Two-sample_mod_T_2020-07-22.xlsx")
shank3.xls <- shank3.xls %>% drop_na(logFC.WT.over.KO)
#shank3.xls <- shank3.xls %>% filter(Shank3_PSD_TMT11_Proteome.numSpectra > 5)

```
Does the data have any underlying structure?

```{r}
shank3.abundances <- shank3.xls %>% dplyr::select(starts_with("Shank3_PSD_TMT11_Proteome.."))

#Renaming columns for clarity
shank3.sampleSheet <- makeSampleSheet(shank3.abundances)
colnames(shank3.abundances) <- shank3.sampleSheet$cleanId


# Remove any rows with NA
shank3.abundances.clean <- na.omit(shank3.abundances)
shank3.abundances.pca.plot <- makePcaPlot(shank3.abundances.clean, shank3.sampleSheet$color)
shank3.abundances.pca.plot
```

Does log transfromation reveal any underlying structure?

```{r}
###
shank3.abundances.clean.log <- log(shank3.abundances.clean+abs(min(shank3.abundances.clean))+1)
shank3.abundances.clean.log.pca.plot <- makePcaPlot(shank3.abundances.clean.log, shank3.sampleSheet$color)
shank3.abundances.clean.log.pca.plot

# No inherent structure in the data
# Samples do not vary primarily by genotype
```

How does expresssion of Shank3 vary with genotype?
Two Shank3 isoforms (SH3 and multiple ankyrin repeat domains protein 3 (overall?), and Isoform 9 of SH3 and multiple ankyrin repeat domains protein 3) were robustly measured in this experiment. Both are plotted. Both look like what one would expect, but hets are not quite halfway between WT and KO (similar to what's seen in the Trio experiment). 

```{r}
# Check abundance of shank3 protein
# Major isoform?
shank3.shank3.abundance.m <- getAbundanceOfProtein(shank3.xls, 
                                             'A0A0A0MQD5',
                                             "Shank3_PSD_TMT11_Proteome..", 
                                             shank3.sampleSheet)
shank3.shank3.abundance.plot <- makeAbundancePlot(shank3.shank3.abundance.m)
shank3.shank3.abundance.plot

# Isoform 9
shank3.shank3.iso.abundance.m <- getAbundanceOfProtein(shank3.xls, 
                                             "Q4ACU6",
                                             "Shank3_PSD_TMT11_Proteome..", 
                                             shank3.sampleSheet)
shank3.shank3.iso.abundance.plot <- makeAbundancePlot(shank3.shank3.iso.abundance.m)
shank3.shank3.iso.abundance.plot

```


The Broad modeling (moderated t-test followed by FDR adjustment) finds that no genes, including Shank3 (adj p-value of 0.19 for major isoform (KO/WT)), are significantly altered after FDR adjustment of p-values. The following plot shows the distribution of FDR adjusted p-values. 

```{r}
plot(density(shank3.xls$adj.P.Val.WT.over.KO), xlim=c(0,1))
```


I am therefore using nominal p-values for further analysis of the data. Here is how the nominal p-value distribution looks like.

```{r}
plot(density(shank3.xls$P.Value.WT.over.KO), xlim=c(0,1))
```


Since we are using nominal p-values, the chances of getting false positive hits is quite high. The number of proteins with p-values below 0.05 is:
```{r}
sum(shank3.xls$P.Value.WT.over.KO < 0.05)
```


Which proteins are the most consistently altered across 

```{r}
#Plotting FDR adjusted p value against LFC
shank3.xls <- shank3.xls %>% dplyr::mutate(logFC.KO.over.WT = logFC.WT.over.KO*(-1))
vPlot <- makeVolcanoPlot(shank3.xls)
vPlot
```

Labeling the genes that Borislav has picked out for further confirmation and has validated antibodies for. 

```{r}
borislavLabels <- c("Trio", "Shank3", "Grin1", "Nrcam", "Dlgap1", "Clu", "Prrt1", "Zdhhc5", "Nono", "Cers6", "Uba52", "Rpl29")
previousLab <- c("Homer1", "Kcnj2", "Dock4", "Nckap1", "Cdkl5", "Dlgap3", "Grik5", "Baiap2", "Dlgap2", "Grin2b", "Gnas", "Grin1", "Trio", "Kcnma1", "Cacna1b", "Nlgn2", "Fer", "Aldh5a1")
vPlot2 <- makeVolcanoPlot(shank3.xls, previousLab)
vPlot2
```


Does the MW of the protein dictate its LFC? To examine this, I divided all proteins into 6 color coded bins. The bins are unequal in size, so that I can see any representative effects at extremes. Bin 1 harbors the proteins with the smallest MW, bin 6 the largest MWs. 
```{r}
shank3.xls <- shank3.xls %>% dplyr::mutate(log_protein_mw = log(protein_mw))
shank3.xls <- setupBins(shank3.xls, "log_protein_mw", c(0,9.5,10.25,11.25,12,12.5,16))
keyvals <- colorizeBins(shank3.xls)
vPlot3 <- makeVolcanoPlot(shank3.xls, NULL, 0.8, keyvals)
vPlot3
```


It does not look like the MW is associated with LFC. To examine this more systematically, I am using the same bins and plotting the cumulative frequency vs. LFC in each bin.
```{r}
#Stratify cumulative frequency by protein MW
lfcCumFreqPlot <- makeStratifiedCumLfcPlot(shank3.xls)
lfcCumFreqPlot
```


In each bin, proteins are as likely to upregulated as they are to be downregulated. Therefore, the MW of a protein does not dictate its LFC. Neither large nor small proteins aren't especially overabundant in Shank3 KO mice. 

MW is related but not wholly representative of the number of amino acids in a protein. Are the alterations in protein expression at the PSD with deletion of Trio associated with the number of amino acids in the protein (the protein length)?
```{r}
#Stratify by CDS length
geneLengths <- read.csv("~/Google Drive/geneSets/geneLengths/S3.genes.results", sep="\t", header=T)
geneLengths <- geneLengths[,c(1:3)]
resLen <- inner_join(shank3.xls, geneLengths, by=c("geneSymbol"="gene_id"))
resLen$aaSize <- resLen$length/3
resLen$logAAsize <- log2(resLen$aaSize)
##### CDS length distribution is shifted left in the PSD compared to tissue RF. Why??
resLen <- setupBins(resLen, "logAAsize", c(0,6.5,7.5,9,10.5,12,16))
keyvals <- colorizeBins(resLen)
vPlot4 <- makeVolcanoPlot(resLen, NULL, 0.8, keyvals, c(0.1,0.9))
vPlot4
```
It does not look like LFC is dependent on protein length either. Analysing this more systematically now. 

```{r}
# Lfcbins has changed now. Stratifying LFC cum freq w/ CDS length bins. 
lfcCumFreqPlot <- makeStratifiedCumLfcPlot(resLen)
lfcCumFreqPlot
```
We can conclude that protein length is not associated with alteration in protein expression. 

Carrying out Gene Set Enrichment Analysis now. 
```{r}
shank3.xls <- shank3.xls %>% mutate(t.KO.over.WT = t.WT.over.KO*(-1))
shank3.xls <- shank3.xls %>% mutate(t.Het.over.WT = t.WT.over.Het*(-1))
goPathways <- "~/Google Drive/geneSets/mSigDb/v7_2/ontology/c5.go.v7.2.symbols.gmt"
shank3.go <- doGoAnalysis(shank3.xls, goPathways, 't.Het.over.WT')
shank3.go$up
shank3.go$down
```
```{r}
goPathways2 <- "~/Google Drive/geneSets/mSigDb/v7_2/curated/c2.cp.kegg.v7.2.symbols.gmt"
shank3.go.kegg <- doGoAnalysis(shank3.xls, goPathways2)
shank3.go.kegg$up
shank3.go.kegg$down
```


What happens if you remove Shank3 from GO analyses? 
```{r}
shank3.xls.tmp <- shank3.xls %>% filter(geneSymbol !='Shank3')
shank3.go.tmp <- doGoAnalysis(shank3.xls.tmp, goPathways)
shank3.go.tmp$up
shank3.go.tmp$down
```

Gene ontologies associated with glutamatergic function are downregulated even when omitting Shank3 from GO analysis. 


Plotting genes associated with RNA splicing GO

```{r}
subsetGenes <- str_to_title(shank3.go$up$x$data$leadingEdge[[3]]) 
subsetGenes.sample <- sample(subsetGenes, min(length(subsetGenes), size = 30))
vPlot5 <- makeVolcanoPlot(shank3.xls, subsetGenes.sample)
vPlot5
```

Plotting genes associated with cytosolic ribosome GO

```{r}
subsetGenes <- str_to_title(shank3.go$up$x$data$leadingEdge[[12]]) ### Translation initiaton
subsetGenes.sample <- sample(subsetGenes, min(length(subsetGenes), size = 30))
vPlot6 <- makeVolcanoPlot(shank3.xls, subsetGenes.sample)
vPlot6
```


Plotting genes associated with glutamate receptor signaling GO

```{r}
subsetGenes <- str_to_title(shank3.go$down$x$data$leadingEdge[[1]]) 
subsetGenes.sample <- sample(subsetGenes, min(length(subsetGenes), size = 30))
vPlot7 <- makeVolcanoPlot(shank3.xls, subsetGenes.sample)
vPlot7
```

Plotting genes associated with antigen processing GO

```{r}
subsetGenes <- str_to_title(shank3.go$down$x$data$leadingEdge[[10]]) 
subsetGenes.sample <- sample(subsetGenes, min(length(subsetGenes), size = 30))
vPlot8 <- makeVolcanoPlot(shank3.xls, subsetGenes.sample)
vPlot8
```
```{r}
shank3.g.abundance.m <- getAbundanceOfProtein(shank3.xls, 
                                             "P10854",
                                             "Shank3_PSD_TMT11_Proteome..", 
                                             shank3.sampleSheet)
shank3.g.abundance.plot <- makeAbundancePlot(shank3.g.abundance.m)
shank3.g.abundance.plot
```
```{r}
glutSigGenes <- shank3.xls %>% subset(geneSymbol %in% subsetGenes)
glutSigGenes.ab <- glutSigGenes %>% select(starts_with("Shank3_PSD_TMT11_Proteome.."))
colnames(glutSigGenes.ab) <- shank3.sampleSheet$cleanId
Heatmap(glutSigGenes.ab, clustering_distance_rows = "pearson")
```
```{r}
shank3.shank3.iso.abundance.m <- getAbundanceOfProtein(shank3.xls, 
                                             "Q8R5L1",
                                             "Shank3_PSD_TMT11_Proteome..", 
                                             shank3.sampleSheet)
shank3.shank3.iso.abundance.plot <- makeAbundancePlot(shank3.shank3.iso.abundance.m)
shank3.shank3.iso.abundance.plot
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
